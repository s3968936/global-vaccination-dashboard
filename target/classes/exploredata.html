<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Explore Data - Global Health Dashboard</title>
    <link rel="stylesheet" type="text/css" href="common.css" />
    <link rel="icon" href="logo_small.png" type="image/png" />
    <!-- Load Google Charts for data visualization -->
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>
  <body class="explore-page" xmlns="http://www.thymeleaf.org">
    <!-- Top Navigation Bar -->
    <div class="simple-topnav">
      <a href="/" class="nav-logo-link">
        <img
          src="logo.png"
          class="nav-logo"
          alt="Global Health Dashboard Logo"
        />
      </a>
      <div class="nav-links">
        <a href="/">Homepage</a>
        <a href="/explore" class="active">Explore Data</a>
        <a href="/trending">Trending</a>
        <a href="/insights">Insights</a>
        <a href="/mission">Mission Statement</a>
        <a href="/feedback">Feedback</a>
      </div>
    </div>

    <!-- Page Header -->
    <div class="header">
      <h1>Explore Data</h1>
      <p class="subtitle">
        Explore global vaccination and infection data trends
      </p>
    </div>

    <!-- Main Content Area -->
    <div class="content data-page-content">
      <h2>Explore Global Vaccination Data</h2>
      <p>
        This page provides comprehensive vaccination coverage data from the World Health Organisation (WHO).
        Analyse immunisation rates across countries, regions, and vaccine types over time. Use the filters below
        to explore specific trends, compare coverage between regions, and identify vaccination gaps. Results include
        interactive charts and detailed tables that can be exported for further analysis.
      </p>

      <!-- Error Message Display -->
      <div th:if="${error}" class="error-message">
        <strong>Error:</strong> <span th:text="${error}"></span>
      </div>

      <!-- Warning Message for Year Validation -->
      <div th:if="${warning}" class="warning-message">
        <strong>Warning:</strong> <span th:text="${warning}"></span>
      </div>

      <!-- Dataset Selector Tabs - Choose between Vaccination and Infection Data -->
      <div class="dataset-selector">
        <div
          class="dataset-tab active"
          id="vaccination-tab"
          onclick="switchDataset('vaccination')"
        >
          Vaccination Data
        </div>
        <div
          class="dataset-tab"
          id="infection-tab"
          onclick="window.location.href='/infection'"
        >
          Infection Data
        </div>
      </div>

      <!-- Filter Form - Users can apply multiple filters to refine their data view -->
      <form method="get" action="/explore" id="filter-form">
        <input
          type="hidden"
          name="datasetType"
          id="datasetType"
          value="vaccination"
        />

        <div class="filter-section">
          <div class="filter-grid">
            <!-- Region Filter - Select geographic region -->
            <div class="combo-box-simple">
              <label for="region">Region</label>
              <input
                type="text"
                id="region"
                name="region"
                placeholder="Type or select region"
                list="region-list"
                th:value="${selectedRegion != null} ? ${selectedRegion} : ''"
              />
              <datalist id="region-list">
                <option
                  th:each="region : ${regions}"
                  th:value="${region}"
                ></option>
              </datalist>
            </div>

            <!-- Country Filter - Select specific country or leave empty for all -->
            <div class="combo-box-simple">
              <label for="country">Country</label>
              <input
                type="text"
                id="country"
                name="country"
                placeholder="Type or select country"
                list="country-list"
                th:value="${selectedCountry != null} ? ${selectedCountry} : ''"
              />
              <datalist id="country-list">
                <option
                  th:each="country : ${countries}"
                  th:value="${country}"
                ></option>
              </datalist>
            </div>

            <!-- Antigen Filter - Select specific vaccine type -->
            <div class="combo-box-simple">
              <label for="antigen" id="antigen-label">Antigen</label>
              <input
                type="text"
                id="antigen"
                name="antigen"
                placeholder="Type or select antigen"
                list="antigen-list"
                th:value="${selectedAntigen != null} ? ${selectedAntigen} : ''"
              />
              <datalist id="antigen-list">
                <option
                  th:each="antigen : ${antigens}"
                  th:value="${antigen}"
                ></option>
              </datalist>
            </div>

            <!-- Year Range Filter - Select start and end years for data range -->
            <div class="combo-box-simple">
              <label for="yearStart">Year Range (2000-2024)</label>
              <div class="year-range">
                <div class="year-start">
                  <input
                    type="text"
                    id="yearStart"
                    name="yearStart"
                    placeholder="2000"
                    list="year-list"
                    th:value="${selectedYearStart != null} ? ${selectedYearStart} : ''"
                  />
                </div>
                <div class="year-separator">to</div>
                <div class="year-end">
                  <input
                    type="text"
                    id="yearEnd"
                    name="yearEnd"
                    placeholder="2024"
                    list="year-list"
                    th:value="${selectedYearEnd != null} ? ${selectedYearEnd} : ''"
                  />
                </div>
              </div>
              <datalist id="year-list">
                <option th:each="year : ${years}" th:value="${year}"></option>
              </datalist>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="filter-actions">
            <button type="submit" class="apply-btn">Apply Filters</button>
            <button type="button" onclick="clearFilters()" class="reset-btn">
              Clear All
            </button>
          </div>
        </div>
      </form>

      <!-- Results Section - Displayed after filters are applied -->
      <div th:if="${hasFilters}">
        <div th:if="${vaccinationData != null and !vaccinationData.empty}">
          <h2>Vaccination Data Results</h2>

          <!-- Chart Section - Visual representation of coverage trends -->
          <div class="chart-container" th:if="${hasChartData}">
            <h3>Coverage Trend</h3>
            <div id="coverage_chart" class="chart-area"></div>
          </div>

          <!-- Message when no chart data is available -->
          <div
            class="chart-container"
            th:if="${hasChartData != null and !hasChartData}"
          >
            <h3>Coverage Trend</h3>
            <div class="chart-no-data">
              <p>No coverage data available for chart display</p>
            </div>
          </div>

          <div
            class="data-table-header"
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 20px;
              padding: 20px;
              background-color: #f8f9fa;
              border-radius: 8px;
              border-left: 4px solid #3498db;
            "
          >
            <!-- Data Table - Detailed tabular view of the filtered data -->
            <h3>Detailed Data</h3>
            <!-- Export Buttons -->
            <div
              class="export-section"
              style="
                text-align: right;
                display: flex;
                flex-direction: column;
                align-items: flex-end;
              "
            >
              <div style="display: flex; gap: 10px; margin-bottom: 8px">
                <button
                  onclick="exportToPDF()"
                  class="export-btn export-btn-pdf"
                  style="
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                    transition: background-color 0.3s;
                    min-width: 140px;
                  "
                >
                  Export Data to PDF
                </button>
                <button
                  onclick="exportToCSV()"
                  class="export-btn export-btn-csv"
                  style="
                    background-color: #28a745;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: bold;
                    transition: background-color 0.3s;
                    min-width: 140px;
                  "
                >
                  Export to CSV
                </button>
              </div>
              <p class="export-note">
                Download the filtered data in your preferred format.
              </p>
            </div>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Year</th>
                <th>Country</th>
                <th>Antigen</th>
                <th>Coverage (%)</th>
                <th>Target Population</th>
                <th>Doses Administered</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="data : ${vaccinationData}">
                <td th:text="${data.year}"></td>
                <td th:text="${data.country}"></td>
                <td th:text="${data.antigen}"></td>
                <td
                  th:text="${#numbers.formatDecimal(data.coverage, 1, 2)}"
                ></td>
                <td
                  th:text="${#numbers.formatDecimal(data.targetNum, 0, 0)}"
                ></td>
                <td th:text="${#numbers.formatDecimal(data.doses, 0, 0)}"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Message when no results are found for the selected filters -->
        <div th:if="${vaccinationData == null or vaccinationData.empty}">
          <div class="no-results-box">
            <h3>No Results Found</h3>
            <p>
              No vaccination data found for the selected criteria. Please try
              different filters or broaden your search criteria.
            </p>
          </div>
        </div>
      </div>

      <!-- Initial State - Displayed when no filters have been applied yet -->
      <div th:if="${hasFilters == null or !hasFilters}">
        <div class="initial-state-box">
          <p>Select one or more filters above to view vaccination data. Charts and data tables will appear here once you apply filters.</p>
        </div>
      </div>
    </div>

    <!-- Footer Section -->
    <footer class="footer">
      <div class="footer-content">
        <p><strong>Global Health Dashboard</strong></p>
        <nav class="footer-links">
          <a href="/">Homepage</a> | <a href="/explore">Explore Data</a> |
          <a href="/trending">Trending</a> | <a href="/insights">Insights</a> |
          <a href="/mission">Mission Statement</a> |
          <a href="/feedback">Feedback</a> |
          <a href="/privacy">Privacy Policy</a>
        </nav>
        <p>
          <small>
            © 2025 RMIT University - Global Vaccination Initiatives | Empowering
            informed global health decisions
          </small>
        </p>
      </div>
    </footer>

    <!-- JavaScript for Chart Visualization -->
    <script th:inline="javascript">
      // Load Google Charts library
      google.charts.load("current", { packages: ["corechart"] });

      // Callback when charts are loaded - check if we have data to display
      google.charts.setOnLoadCallback(function () {
        const hasFilters = /*[[${hasFilters}]]*/ false;
        const hasChartData = /*[[${hasChartData}]]*/ false;
        const chartDataRaw = /*[[${chartDataJson}]]*/ "[]";

        // Parse chart data safely - Thymeleaf replaces variables before rendering
        let chartData;
        try {
          chartData = JSON.parse(chartDataRaw);
        } catch (e) {
          console.error("Error parsing chart data:", e);
          chartData = [];
        }

        // Draw chart if we have data, otherwise clear the area
        if (hasFilters && hasChartData && chartData.length > 0) {
          drawCoverageChart(chartData);
        } else {
          clearChartArea();
        }
      });

      /**
       * Draws the vaccination coverage chart using Google Charts
       * @param {Array} chartData - Array of [year, coverage] pairs
       */
      function drawCoverageChart(chartData) {
        const chartDiv = document.getElementById("coverage_chart");
        if (!chartDiv) return;

        // Get the dynamic chart title from the server (generated based on filters)
        const chartTitle =
          /*[[${chartTitle}]]*/ "Vaccination Coverage Over Time";

        // Create data table for Google Charts
        const data = new google.visualization.DataTable();
        data.addColumn("number", "Year");
        data.addColumn("number", "Coverage (%)");

        // Convert string years to numbers and prepare data for chart
        const numericData = chartData.map((item) => {
          const year = parseInt(item[0]); // Convert year string to number
          const coverage = item[1]; // Coverage percentage
          return [year, coverage];
        });

        data.addRows(numericData);

        // Chart configuration options
        const options = {
          title: chartTitle, // Dynamic title based on filters
          titlePosition: "center", // Center the chart title
          titleTextStyle: {
            fontSize: 18,
            bold: true,
            color: "#2c3e50",
          },
          hAxis: {
            title: "Year",
            format: "####", // Show as 4-digit years
            gridlines: { count: -1 }, // Automatic gridlines
          },
          vAxis: {
            title: "Coverage (%)",
            viewWindow: {
              min: 0,
              max: 150, // Realistic max for coverage percentages
            },
            format: "#'%'", // Add percentage symbol to values
            gridlines: { color: "#f5f5f5" },
          },
          legend: {
            position: "none", // Remove legend since we only have one line
          },
          colors: ["#4285F4"], // Google blue color
          curveType: "function", // Smooth curves for better visualization
          pointSize: 5,
          pointShape: "circle",
          backgroundColor: "transparent",
          chartArea: {
            width: "85%",
            height: "70%",
            top: 60,
          },
          crosshair: {
            trigger: "both", // Show crosshair on focus and selection
            orientation: "vertical",
          },
        };

        // Create and draw the line chart
        const chart = new google.visualization.LineChart(chartDiv);
        chart.draw(data, options);

        // Add interactivity - change cursor on hover
        google.visualization.events.addListener(
          chart,
          "onmouseover",
          function (e) {
            chartDiv.style.cursor = "pointer";
          }
        );

        google.visualization.events.addListener(
          chart,
          "onmouseout",
          function (e) {
            chartDiv.style.cursor = "default";
          }
        );
      }

      /**
       * Clears the chart area and shows a message when no data is available
       */
      function clearChartArea() {
        const chartDiv = document.getElementById("coverage_chart");
        if (chartDiv) {
          chartDiv.innerHTML =
            "<p style='text-align:center; color:#777; padding:60px;'>No data available for the selected filters</p>";
        }
      }

      // Redraw chart when window is resized for responsiveness
      window.addEventListener("resize", function () {
        const hasFilters = /*[[${hasFilters}]]*/ false;
        const hasChartData = /*[[${hasChartData}]]*/ false;
        const chartDataRaw = /*[[${chartDataJson}]]*/ "[]";

        if (hasFilters && hasChartData) {
          try {
            const chartData = JSON.parse(chartDataRaw);
            drawCoverageChart(chartData);
          } catch (e) {
            console.error("Resize chart draw failed:", e);
          }
        }
      });

      /**
       * Clears all filters and resets the form
       */
      function clearFilters() {
        document
          .querySelectorAll("#filter-form input")
          .forEach((el) => (el.value = ""));
        clearChartArea();
        // Reload page after short delay to show cleared state
        setTimeout(() => (window.location.href = "/explore"), 300);
      }

      /**
       * Exports the filtered data to PDF
       */
      function exportToPDF() {
        // Get current filter values
        const country = document.getElementById("country").value;
        const region = document.getElementById("region").value;
        const antigen = document.getElementById("antigen").value;
        const yearStart = document.getElementById("yearStart").value;
        const yearEnd = document.getElementById("yearEnd").value;

        // Build export URL with current filters
        let exportUrl = "/export/pdf?";
        const params = [];

        if (country) params.push("country=" + encodeURIComponent(country));
        if (region) params.push("region=" + encodeURIComponent(region));
        if (antigen) params.push("antigen=" + encodeURIComponent(antigen));
        if (yearStart)
          params.push("yearStart=" + encodeURIComponent(yearStart));
        if (yearEnd) params.push("yearEnd=" + encodeURIComponent(yearEnd));

        exportUrl += params.join("&");

        // Show loading state
        const exportBtn = document.querySelector(".export-btn");
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = "⏳ Generating PDF...";
        exportBtn.disabled = true;

        // Trigger download
        const downloadLink = document.createElement("a");
        downloadLink.href = exportUrl;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // Reset button after a short delay
        setTimeout(() => {
          exportBtn.innerHTML = originalText;
          exportBtn.disabled = false;
        }, 2000);
      }

      /**
       * Exports the filtered data to CSV
       */
      function exportToCSV() {
        // Get current filter values
        const country = document.getElementById("country").value;
        const region = document.getElementById("region").value;
        const antigen = document.getElementById("antigen").value;
        const yearStart = document.getElementById("yearStart").value;
        const yearEnd = document.getElementById("yearEnd").value;

        // Build export URL with current filters
        let exportUrl = "/export/csv?";
        const params = [];

        if (country) params.push("country=" + encodeURIComponent(country));
        if (region) params.push("region=" + encodeURIComponent(region));
        if (antigen) params.push("antigen=" + encodeURIComponent(antigen));
        if (yearStart)
          params.push("yearStart=" + encodeURIComponent(yearStart));
        if (yearEnd) params.push("yearEnd=" + encodeURIComponent(yearEnd));

        exportUrl += params.join("&");

        // Show loading state
        const exportBtn = document.querySelector(
          '.export-btn[onclick="exportToCSV()"]'
        );
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = "⏳ Generating CSV...";
        exportBtn.disabled = true;

        // Trigger download
        const downloadLink = document.createElement("a");
        downloadLink.href = exportUrl;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // Reset button after a short delay
        setTimeout(() => {
          exportBtn.innerHTML = originalText;
          exportBtn.disabled = false;
        }, 2000);
      }
    </script>
  </body>
</html>
