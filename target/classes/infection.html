<!DOCTYPE html>
<html
  lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Infection Data - Global Health Dashboard</title>
    <link rel="stylesheet" type="text/css" href="common.css" />
    <!-- Google Charts -->
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>
  <body class="infection-page">
    <!-- Top Navigation -->
    <div class="simple-topnav">
      <a href="/" class="nav-logo-link">
        <img
          src="logo.png"
          class="nav-logo"
          alt="Global Health Dashboard Logo"
        />
      </a>
      <div class="nav-links">
        <a href="/">Homepage</a>
        <a href="/explore" class="active">Explore Data</a>
        <a href="/trending">Trending</a>
        <a href="/insights">Insights</a>
        <a href="/mission">Mission Statement</a>
        <a href="/feedback">Feedback</a>
      </div>
    </div>

    <div class="header">
      <h1>Infection Data</h1>
      <p class="subtitle">
        Analyse global infection trends and disease patterns
      </p>
    </div>

    <div class="content data-page-content">
      <h2>Explore Global Infection Data</h2>
      <p>
        Track vaccine-preventable diseases and infection patterns worldwide.
        This page provides global infection case data that lets you view disease
        burden across countries, economic development levels, and time periods.
        Use the filters below to compare infection rates, identify outbreak
        patterns, and understand the relationship between economic status and
        disease spread. Results can be saved for your own use.
      </p>

      <!-- Error Message -->
      <div th:if="${error}" class="error-message">
        <strong>Error:</strong> <span th:text="${error}"></span>
      </div>

      <!-- Warning Message -->
      <div th:if="${warning}" class="warning-message">
        <strong>Warning:</strong> <span th:text="${warning}"></span>
      </div>

      <!-- Dataset Tabs -->
      <div class="dataset-selector">
        <div
          class="dataset-tab"
          id="vaccination-tab"
          onclick="window.location.href='/explore'"
        >
          Vaccination Data
        </div>
        <div class="dataset-tab active" id="infection-tab">Infection Data</div>
      </div>

      <!-- Filter Form -->
      <form method="get" action="/infection" id="filter-form">
        <input
          type="hidden"
          name="datasetType"
          id="datasetType"
          value="infection"
        />

        <div class="filter-section">
          <p class="filter-note">
            <strong>Note:</strong> All filters are optional. Select one or more
            filters to view data.
          </p>
          <div class="filter-grid">
            <div class="combo-box-simple">
              <label for="economicStatus">Economic Status</label>
              <input
                type="text"
                id="economicStatus"
                name="economicStatus"
                placeholder="Type or select economic status"
                list="economicStatus-list"
                th:value="${selectedEconomicStatus != null} ? ${selectedEconomicStatus} : ''"
              />
              <datalist id="economicStatus-list">
                <option
                  th:each="status : ${economicStatuses}"
                  th:value="${status}"
                ></option>
              </datalist>
            </div>

            <div class="combo-box-simple">
              <label for="country">Country</label>
              <input
                type="text"
                id="country"
                name="country"
                placeholder="Type or select country"
                list="country-list"
                th:value="${selectedCountry != null} ? ${selectedCountry} : ''"
              />
              <datalist id="country-list">
                <option
                  th:each="country : ${countries}"
                  th:value="${country}"
                ></option>
              </datalist>
            </div>

            <div class="combo-box-simple">
              <label for="infectionType">Infection Type</label>
              <input
                type="text"
                id="infectionType"
                name="infectionType"
                placeholder="Type or select infection type"
                list="infectionType-list"
                th:value="${selectedInfectionType != null} ? ${selectedInfectionType} : ''"
              />
              <datalist id="infectionType-list">
                <option
                  th:each="infectionType : ${infectionTypes}"
                  th:value="${infectionType}"
                ></option>
              </datalist>
            </div>

            <div class="combo-box-simple">
              <label for="yearStart">Year Range (2000-2024)</label>
              <div class="year-range">
                <div class="year-start">
                  <input
                    type="text"
                    id="yearStart"
                    name="yearStart"
                    placeholder="2000"
                    list="year-list"
                    th:value="${selectedYearStart != null} ? ${selectedYearStart} : ''"
                  />
                </div>
                <div class="year-separator">to</div>
                <div class="year-end">
                  <input
                    type="text"
                    id="yearEnd"
                    name="yearEnd"
                    placeholder="2024"
                    list="year-list"
                    th:value="${selectedYearEnd != null} ? ${selectedYearEnd} : ''"
                  />
                </div>
              </div>
              <datalist id="year-list">
                <option th:each="year : ${years}" th:value="${year}"></option>
              </datalist>
            </div>
          </div>

          <div class="filter-actions">
            <button type="submit" class="apply-btn">Apply Filters</button>
            <button type="button" onclick="clearFilters()" class="reset-btn">
              Clear All
            </button>
          </div>
        </div>
      </form>

      <!-- Results -->
      <div th:if="${hasFilters}">
        <div th:if="${infectionData != null and !infectionData.empty}">
          <h2>Infection Data Results</h2>

          <!-- Chart -->
          <div class="chart-container" th:if="${hasChartData}">
            <h3>Infection Trend</h3>
            <div id="infection_chart" class="infection-chart-container"></div>
          </div>

          <div
            class="chart-container"
            th:if="${hasChartData != null and !hasChartData}"
          >
            <h3>Infection Trend</h3>
            <div class="chart-no-data">
              <p>No infection data available for chart display</p>
            </div>
          </div>

          <!-- Data Table -->
          <div class="data-table-header">
            <h3>Detailed Data</h3>
            <div class="export-section">
              <div class="export-buttons-container">
                <button
                  onclick="exportToPDF()"
                  class="export-btn export-btn-pdf"
                >
                  Export Data to PDF
                </button>

                <button
                  onclick="exportToCSV()"
                  class="export-btn export-btn-csv"
                >
                  Export to CSV
                </button>
              </div>
              <p class="export-note">
                Download the filtered data in your preferred format.
              </p>
            </div>
          </div>

          <table class="data-table" id="resultsTable">
            <thead>
              <tr>
                <th>Year</th>
                <th>Country</th>
                <th>Economic Status</th>
                <th>Infection Type</th>
                <th>Cases</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="data : ${infectionData}">
                <td th:text="${data.year}"></td>
                <td th:text="${data.country}"></td>
                <td th:text="${data.economicStatus}"></td>
                <td th:text="${data.infType}"></td>
                <td th:text="${#numbers.formatDecimal(data.cases, 0, 0)}"></td>
              </tr>
            </tbody>
          </table>

          <div class="row-count-info">
            Showing <span id="visibleRowCount">0</span> of
            <span th:text="${infectionData.size()}">0</span> rows
          </div>
        </div>

        <div th:if="${infectionData == null or infectionData.empty}">
          <div class="no-results-box">
            <h3>No Results Found</h3>
            <p>
              No infection data found for the selected criteria. Please try
              different filters.
            </p>
          </div>
        </div>
      </div>

      <!-- Initial State -->
      <div th:if="${hasFilters == null or !hasFilters}">
        <div class="initial-state-box">
          <p>
            Select one or more filters above to view infection data. Charts and
            data tables will appear here once you apply filters.
          </p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <p><strong>Global Health Dashboard</strong></p>
        <nav class="footer-links">
          <a href="/">Homepage</a> | <a href="/explore">Explore Data</a> |
          <a href="/trending">Trending</a> | <a href="/insights">Insights</a> |
          <a href="/mission">Mission Statement</a> |
          <a href="/feedback">Feedback</a> |
          <a href="/privacy">Privacy Policy</a>
        </nav>
        <p>
          <small>
            © 2025 RMIT University - Global Vaccination Initiatives | Empowering
            informed global health decisions
          </small>
        </p>
      </div>
    </footer>

    <!-- Chart Script -->
    <script th:inline="javascript">
      google.charts.load("current", { packages: ["corechart"] });

      google.charts.setOnLoadCallback(function () {
        const hasFilters = /*[[${hasFilters}]]*/ false;
        const hasChartData = /*[[${hasChartData}]]*/ false;
        const chartDataRaw = /*[[${chartDataJson}]]*/ "[]";

        // Parse safely — Thymeleaf replaces variables before rendering
        let chartData;
        try {
          chartData = JSON.parse(chartDataRaw);
        } catch (e) {
          console.error("Error parsing chart data:", e);
          chartData = [];
        }

        if (hasFilters && hasChartData && chartData.length > 0) {
          drawInfectionChart(chartData);
        } else {
          clearChartArea();
        }

        // Initialize table features
        initTableSorting();
        updateRowCount();
      });

      function drawInfectionChart(chartData) {
        const chartDiv = document.getElementById("infection_chart");
        if (!chartDiv) return;

        //get chart title from Thymeleaf variable
        const chartTitle = /*[[${chartTitle}]]*/ "Infection Cases Over Time";

        // Convert chart data to use numbers for years instead of strings
        const data = new google.visualization.DataTable();
        data.addColumn("number", "Year");
        data.addColumn("number", "Cases");

        // Convert string years to numbers and prepare data
        const numericData = chartData.map((item) => {
          // item[0] is the label like "2000 - Measles", extract the year
          const yearLabel = item[0];
          const year = parseInt(yearLabel.split(" - ")[0]); // Extract year from "2000 - Measles"
          const cases = item[1];
          return [year, cases];
        });

        data.addRows(numericData);

        const options = {
          title: chartTitle,
          hAxis: {
            title: "Year",
            format: "####", // Show as 4-digit years
            gridlines: { count: -1 }, // Automatic gridlines
          },
          vAxis: {
            title: "Number of Cases",
            viewWindow: { min: 0 },
            format: "short", // Use abbreviated numbers for large case counts
            gridlines: { color: "#f5f5f5" },
          },
          legend: {
            position: "none",
          },
          colors: ["#e74c3c"], // Red color for infection cases
          backgroundColor: "transparent",
          chartArea: {
            width: "85%",
            height: "70%",
            top: 60,
          },
        };

        const chart = new google.visualization.ColumnChart(chartDiv);
        chart.draw(data, options);
      }

      function clearChartArea() {
        const chartDiv = document.getElementById("infection_chart");
        if (chartDiv) {
          chartDiv.innerHTML =
            "<p class='chart-no-data'>No infection data available for chart display</p>";
        }
      }

      // Table sorting function
      function initTableSorting() {
        const table = document.getElementById("resultsTable");
        if (!table) return;

        const headers = table.querySelectorAll("th");
        const tbody = table.querySelector("tbody");

        headers.forEach((header, index) => {
          header.style.cursor = "pointer";
          header.style.position = "relative";
          header.style.paddingRight = "25px";

          header.addEventListener("click", () => {
            // Remove sort classes from all headers
            headers.forEach((h) => {
              h.classList.remove("sort-asc", "sort-desc");
            });

            // Determine new sort direction
            const isAsc = !header.classList.contains("sort-asc");
            header.classList.add(isAsc ? "sort-asc" : "sort-desc");

            // Sort the table
            sortTableByColumn(table, index, isAsc);
            updateRowCount();
          });
        });

        function sortTableByColumn(table, column, ascending = true) {
          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));

          const sortedRows = rows.sort((a, b) => {
            const aColText = a.cells[column].textContent.trim();
            const bColText = b.cells[column].textContent.trim();

            // Handle numeric columns (Year, Cases)
            if ([0, 4].includes(column)) {
              const aNum = parseFloat(aColText.replace(/,/g, "")) || 0;
              const bNum = parseFloat(bColText.replace(/,/g, "")) || 0;
              return ascending ? aNum - bNum : bNum - aNum;
            }

            // Handle text columns (Country, Economic Status, Infection Type)
            return ascending
              ? aColText.localeCompare(bColText)
              : bColText.localeCompare(aColText);
          });

          // Remove all existing rows
          while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
          }

          // Re-add sorted rows
          tbody.append(...sortedRows);
        }
      }

      function updateRowCount() {
        const countElement = document.getElementById("visibleRowCount");
        if (!countElement) return;

        const table = document.getElementById("resultsTable");
        if (!table) return;

        const visibleRows = table.querySelectorAll(
          'tbody tr:not([style*="display: none"])'
        );
        countElement.textContent = visibleRows.length;
      }

      function clearFilters() {
        document
          .querySelectorAll("#filter-form input")
          .forEach((el) => (el.value = ""));
        clearChartArea();
        setTimeout(() => (window.location.href = "/infection"), 300);
      }

      window.addEventListener("resize", function () {
        const hasFilters = /*[[${hasFilters}]]*/ false;
        const hasChartData = /*[[${hasChartData}]]*/ false;
        const chartDataRaw = /*[[${chartDataJson}]]*/ "[]";

        if (hasFilters && hasChartData) {
          try {
            const chartData = JSON.parse(chartDataRaw);
            drawInfectionChart(chartData);
          } catch (e) {
            console.error("Resize chart draw failed:", e);
          }
        }
      });

      /**
       * Exports the filtered infection data to CSV
       */
      function exportToCSV() {
        // Get current filter values
        const country = document.getElementById("country").value;
        const economicStatus = document.getElementById("economicStatus").value;
        const infectionType = document.getElementById("infectionType").value;
        const yearStart = document.getElementById("yearStart").value;
        const yearEnd = document.getElementById("yearEnd").value;

        // Build export URL with current filters
        let exportUrl = "/export/infection/csv?";
        const params = [];

        if (country) params.push("country=" + encodeURIComponent(country));
        if (economicStatus)
          params.push("economicStatus=" + encodeURIComponent(economicStatus));
        if (infectionType)
          params.push("infectionType=" + encodeURIComponent(infectionType));
        if (yearStart)
          params.push("yearStart=" + encodeURIComponent(yearStart));
        if (yearEnd) params.push("yearEnd=" + encodeURIComponent(yearEnd));

        exportUrl += params.join("&");

        // Show loading state
        const exportBtn = document.querySelector(
          '.export-btn[onclick="exportToCSV()"]'
        );
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = "⏳ Generating CSV...";
        exportBtn.disabled = true;

        // Trigger download
        const downloadLink = document.createElement("a");
        downloadLink.href = exportUrl;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // Reset button after a short delay
        setTimeout(() => {
          exportBtn.innerHTML = originalText;
          exportBtn.disabled = false;
        }, 2000);
      }

      /**
       * Exports the filtered infection data to PDF
       */
      function exportToPDF() {
        // Get current filter values
        const country = document.getElementById("country").value;
        const economicStatus = document.getElementById("economicStatus").value;
        const infectionType = document.getElementById("infectionType").value;
        const yearStart = document.getElementById("yearStart").value;
        const yearEnd = document.getElementById("yearEnd").value;

        // Build export URL with current filters
        let exportUrl = "/export/infection/pdf?";
        const params = [];

        if (country) params.push("country=" + encodeURIComponent(country));
        if (economicStatus)
          params.push("economicStatus=" + encodeURIComponent(economicStatus));
        if (infectionType)
          params.push("infectionType=" + encodeURIComponent(infectionType));
        if (yearStart)
          params.push("yearStart=" + encodeURIComponent(yearStart));
        if (yearEnd) params.push("yearEnd=" + encodeURIComponent(yearEnd));

        exportUrl += params.join("&");

        // Show loading state
        const exportBtn = document.querySelector(
          '.export-btn[onclick="exportToPDF()"]'
        );
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = "⏳ Generating PDF...";
        exportBtn.disabled = true;

        // Trigger download
        const downloadLink = document.createElement("a");
        downloadLink.href = exportUrl;
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        // Reset button after a short delay
        setTimeout(() => {
          exportBtn.innerHTML = originalText;
          exportBtn.disabled = false;
        }, 2000);
      }

      // ADD the method to update country options based on economic status
      const economicStatusCountries = /*[[${economicStatusCountries}]]*/ {};

      function updateCountryOptions() {
        const economicStatus = document
          .getElementById("economicStatus")
          .value.trim();
        const countryDatalist = document.getElementById("country-list");

        // Clear and rebuild datalist options
        countryDatalist.innerHTML = "";

        const countriesToShow =
          economicStatus && economicStatusCountries[economicStatus]
            ? economicStatusCountries[economicStatus]
            : /*[[${countries}]]*/ [];

        countriesToShow.forEach((country) => {
          const option = document.createElement("option");
          option.value = country;
          countryDatalist.appendChild(option);
        });
      }

      // Initialize dependent filtering when page loads
      document.addEventListener("DOMContentLoaded", function () {
        updateCountryOptions(); // Set initial state

        // Add event listeners for economic status changes
        document
          .getElementById("economicStatus")
          .addEventListener("input", updateCountryOptions);
        document
          .getElementById("economicStatus")
          .addEventListener("change", updateCountryOptions);
      });
    </script>
  </body>
</html>
