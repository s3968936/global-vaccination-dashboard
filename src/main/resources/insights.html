<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Insights - Global Health Dashboard</title>
    <link rel="stylesheet" type="text/css" href="common.css" />
    <link rel="icon" href="logo_small.png" type="image/png" />
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>
  <body>
    <!-- Top Navigation -->
    <div class="simple-topnav">
      <a href="/" class="nav-logo-link">
        <img
          src="logo.png"
          class="nav-logo"
          alt="Global Health Dashboard Logo"
        />
      </a>
      <div class="nav-links">
        <a href="/">Homepage</a>
        <a href="/explore">Explore Data</a>
        <a href="/trending">Trending</a>
        <a href="/insights" class="active">Insights</a>
        <a href="/mission">Mission Statement</a>
        <a href="/feedback">Feedback</a>
      </div>
    </div>

    <!-- Page Header -->
    <div class="header">
      <h1>Global Vaccination Insights</h1>
      <p class="subtitle">
        Vaccination coverage rates by country with interactive world map
      </p>
    </div>

    <!-- Content -->
    <div class="content data-page-content">
      <h2>Global Vaccination Coverage Map</h2>
      <p>
        Visualise vaccination coverage across the globe with an interactive world map. This page displays average
        vaccination rates for each country, combining data across all vaccine types to provide a comprehensive overview
        of global immunisation efforts. Compare countries at a glance using the colour-coded map, or browse the detailed
        country table for specific coverage percentages. The map helps identify regions with strong vaccination programs
        and areas that may need additional support.
      </p>

      <!-- Main Content: Country Table + Map -->
      <div th:if="${hasData}" class="insights-container">
        <!-- Country Table -->
        <div class="country-table">
          <h3>Country Coverage Data</h3>
          <table class="data-table">
            <thead>
              <tr>
                <th>Country</th>
                <th>Coverage %</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="item : ${geoData}">
                <td th:text="${item.country_name}">Country</td>
                <td
                  class="coverage-cell"
                  th:classappend="${item.coverage_percentage >= 80} ? 'coverage-high' : 
                                  (${item.coverage_percentage >= 50} ? 'coverage-medium' : 'coverage-low')"
                  th:text="${item.coverage_percentage} + '%'"
                >
                  0%
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Geo Chart -->
        <div class="chart-container">
          <div id="regions_div" style="width: 100%; height: 100%"></div>
        </div>
      </div>

      <!-- No Data Message -->
      <div th:unless="${hasData}" class="initial-state-box">
        <p>Unable to load vaccination coverage data. Please try refreshing the page.</p>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <p><strong>Global Health Dashboard</strong></p>
        <nav class="footer-links">
          <a href="/">Homepage</a> | <a href="/explore">Explore Data</a> |
          <a href="/trending">Trending</a> | <a href="/insights">Insights</a> |
          <a href="/mission">Mission Statement</a> |
          <a href="/feedback">Feedback</a> |
          <a href="/privacy">Privacy Policy</a>
        </nav>
        <p>
          <small>
            © 2025 RMIT University - Global Vaccination Initiatives | Empowering
            informed global health decisions
          </small>
        </p>
      </div>
    </footer>

    <!-- Google Charts Script -->
    <script th:inline="javascript">
      console.log("=== GEO CHART ===");

      google.charts.load("current", {
        packages: ["geochart"],
      });

      google.charts.setOnLoadCallback(function () {
        console.log("Google Charts loaded");
        drawChart();
      });

      function drawChart() {
        const chartDiv = document.getElementById("regions_div");
        if (!chartDiv) {
          console.error("Chart container not found");
          return;
        }

        try {
          const geoChartData = /*[[${geoChartData}]]*/ "[]";
          console.log("Raw data:", geoChartData);

          // Parse the data
          const dataArray = JSON.parse(geoChartData);
          console.log("Parsed data array with", dataArray.length, "rows");

          // Create data table
          const data = google.visualization.arrayToDataTable(dataArray);

          // Chart options
          const options = {
            title: "Global Vaccination Coverage (%)",
            colorAxis: {
              colors: ["#E8F0FE", "#D2E3FC", "#9BC1F9", "#5E9AF9", "#2E68CF"],
              minValue: 0,
              maxValue: 100,
            },
            backgroundColor: "#ffffff",
            datalessRegionColor: "#f5f5f5",
            defaultColor: "#f5f5f5",
            legend: {
              textStyle: {
                color: "#333",
                fontSize: 12,
              },
            },
            tooltip: {
              textStyle: {
                color: "#333",
                fontSize: 14,
              },
              showTitle: true,
            },
            region: "world",
          };

          // Draw chart
          const chart = new google.visualization.GeoChart(chartDiv);
          chart.draw(data, options);
          console.log("✅ Chart successfully drawn!");
        } catch (error) {
          console.error("Chart error:", error);
          chartDiv.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <h3>Map Loading Issue</h3>
                    <p>${error.message}</p>
                    <p>Please check the browser console for details.</p>
                </div>
            `;
        }
      }
    </script>
  </body>
</html>
