<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Insights - Global Health Dashboard</title>
    <link rel="stylesheet" type="text/css" href="common.css" />
    <link rel="icon" href="logo_small.png" type="image/png" />
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>
  <body>
    <!-- Top Navigation -->
    <div class="simple-topnav">
      <a href="/" class="nav-logo-link">
        <img
          src="logo.png"
          class="nav-logo"
          alt="Global Health Dashboard Logo"
        />
      </a>
      <div class="nav-links">
        <a href="/">Homepage</a>
        <a href="/explore">Explore Data</a>
        <a href="/trending">Trending</a>
        <a href="/insights" class="active">Insights</a>
        <a href="/mission">Mission Statement</a>
        <a href="/feedback">Feedback</a>
      </div>
    </div>

    <!-- Page Header -->
    <div class="header">
      <h1>Global Vaccination Insights</h1>
      <p class="subtitle">
        Identify countries with the biggest improvement in vaccination rates
      </p>
    </div>

    <!-- Content -->
    <div class="content data-page-content">
      <h2>Vaccination Rate Improvements</h2>
      <p>
        Analyse which countries have made the greatest progress in vaccination coverage over time. Select a year range
        and vaccine type to see how vaccination rates have improved globally. The interactive world map displays
        improvement as percentage point increases, with darker blue indicating greater improvement. This analysis helps
        identify successful vaccination programmes and countries that have made significant strides in protecting their
        populations against preventable diseases.
      </p>

      <!-- Filter Form -->
      <form method="get" action="/insights" id="filter-form">
        <div class="filter-section">
          <div class="filter-grid">
            <!-- Start Year Filter -->
            <div class="combo-box-simple">
              <label for="start_year">Start Year <span class="required-field">*</span></label>
              <input
                type="text"
                id="start_year"
                name="start_year"
                placeholder="Select start year"
                list="start-year-list"
                th:value="${selectedStartYear}"
                required
              />
              <datalist id="start-year-list">
                <option th:each="year : ${years}" th:value="${year}"></option>
              </datalist>
            </div>

            <!-- End Year Filter -->
            <div class="combo-box-simple">
              <label for="end_year">End Year <span class="required-field">*</span></label>
              <input
                type="text"
                id="end_year"
                name="end_year"
                placeholder="Select end year"
                list="end-year-list"
                th:value="${selectedEndYear}"
                required
              />
              <datalist id="end-year-list">
                <option th:each="year : ${years}" th:value="${year}"></option>
              </datalist>
            </div>

            <!-- Vaccine Type Filter -->
            <div class="combo-box-simple">
              <label for="antigen">Vaccine Type</label>
              <input
                type="text"
                id="antigen"
                name="antigen"
                placeholder="All Vaccines"
                list="antigen-list"
                th:value="${selectedAntigen}"
              />
              <datalist id="antigen-list">
                <option value="All Vaccines"></option>
                <option th:each="antigen : ${antigens}" th:value="${antigen}"></option>
              </datalist>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="filter-actions">
            <button type="submit" class="apply-btn">Apply Filters</button>
            <button
              type="button"
              class="reset-btn"
              onclick="window.location.href='/insights'"
            >
              Clear All
            </button>
          </div>
        </div>
      </form>

      <!-- No Data Message -->
      <div th:unless="${hasData}" class="initial-state-box">
        <p>Select a start year and end year to view vaccination rate improvements.</p>
      </div>
    </div>

    <!-- Main Content: Country Table + Map -->
    <div th:if="${hasData}" class="insights-results-card">
      <div class="insights-container">
        <!-- Country Table -->
        <div class="country-table">
          <h3>Country Improvement Data</h3>
          <table class="data-table">
            <thead>
              <tr>
                <th>Country</th>
                <th>Initial Coverage (%)</th>
                <th>Final Coverage (%)</th>
                <th>Improvement (% points)</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="item : ${geoData}">
                <td th:text="${item.country_name}">Country</td>
                <td th:text="${item.initial_coverage != null ? item.initial_coverage + '%' : 'N/A'}">0%</td>
                <td th:text="${item.final_coverage != null ? item.final_coverage + '%' : 'N/A'}">0%</td>
                <td
                  class="improvement-cell"
                  th:text="${item.improvement != null ? (item.improvement.startsWith('-') ? item.improvement : '+' + item.improvement) : 'N/A'}"
                >
                  0
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Geo Chart -->
        <div class="chart-container">
          <div id="regions_div" style="width: 100%; height: 100%"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <p><strong>Global Health Dashboard</strong></p>
        <nav class="footer-links">
          <a href="/">Homepage</a> | <a href="/explore">Explore Data</a> |
          <a href="/trending">Trending</a> | <a href="/insights">Insights</a> |
          <a href="/mission">Mission Statement</a> |
          <a href="/feedback">Feedback</a> |
          <a href="/privacy">Privacy Policy</a>
        </nav>
        <p>
          <small>
            © 2025 RMIT University - Global Vaccination Initiatives | Empowering
            informed global health decisions
          </small>
        </p>
      </div>
    </footer>

    <!-- Google Charts Script -->
    <script th:inline="javascript">
      console.log("=== GEO CHART ===");

      google.charts.load("current", {
        packages: ["geochart"],
      });

      google.charts.setOnLoadCallback(function () {
        console.log("Google Charts loaded");
        drawChart();
      });

      function drawChart() {
        const chartDiv = document.getElementById("regions_div");
        if (!chartDiv) {
          console.error("Chart container not found");
          return;
        }

        try {
          const geoChartData = /*[[${geoChartData}]]*/ "[]";
          console.log("Raw data:", geoChartData);

          // Parse the data
          const dataArray = JSON.parse(geoChartData);
          console.log("Parsed data array with", dataArray.length, "rows");

          // Create data table
          const data = google.visualization.arrayToDataTable(dataArray);

          // Chart options
          const options = {
            title: "Vaccination Rate Improvement (Percentage Points)",
            colorAxis: {
              colors: ["#E8F0FE", "#D2E3FC", "#9BC1F9", "#5E9AF9", "#2E68CF"],
              minValue: 0,
              maxValue: 50,
            },
            backgroundColor: "#ffffff",
            datalessRegionColor: "#f5f5f5",
            defaultColor: "#f5f5f5",
            legend: {
              textStyle: {
                color: "#333",
                fontSize: 12,
              },
            },
            tooltip: {
              textStyle: {
                color: "#333",
                fontSize: 14,
              },
              showTitle: true,
            },
            region: "world",
          };

          // Draw chart
          const chart = new google.visualization.GeoChart(chartDiv);
          chart.draw(data, options);
          console.log("✅ Chart successfully drawn!");
        } catch (error) {
          console.error("Chart error:", error);
          chartDiv.innerHTML = `
                <div style="text-align: center; padding: 50px; color: #666;">
                    <h3>Map Loading Issue</h3>
                    <p>${error.message}</p>
                    <p>Please check the browser console for details.</p>
                </div>
            `;
        }
      }
    </script>
  </body>
</html>
