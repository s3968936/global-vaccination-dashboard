<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Insights - Global Health Dashboard</title>
    <link rel="stylesheet" type="text/css" href="common.css" />
    <link rel="icon" href="logo_small.png" type="image/png" />
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
  </head>
  <body>
    <!-- Top Navigation -->
    <div class="simple-topnav">
      <a href="/" class="nav-logo-link">
        <img
          src="logo.png"
          class="nav-logo"
          alt="Global Health Dashboard Logo"
        />
      </a>
      <div class="nav-links">
        <a href="/">Homepage</a>
        <a href="/explore">Explore Data</a>
        <a href="/trending">Trending</a>
        <a href="/insights" class="active">Insights</a>
        <a href="/mission">Mission Statement</a>
        <a href="/feedback">Feedback</a>
      </div>
    </div>

    <!-- Page Header -->
    <div class="header">
      <h1>Global Vaccination Insights</h1>
      <p class="subtitle">
        Identify countries with the biggest improvement in vaccination rates
      </p>
    </div>

    <!-- Content -->
    <div class="content data-page-content">
      <h2>Vaccination Rate Improvements</h2>
      <p>
        See which countries have made the greatest progress in vaccination
        coverage over time. Select a year range and vaccine type to see how
        vaccination rates have improved globally. The interactive world map
        shows improvement as percentage increases, with darker blue showing
        greater improvement. This helps identify successful vaccination
        programmes and countries that have made significant progress in
        protecting their populations against preventable diseases.
      </p>

      <!-- Error Message -->
      <div th:if="${error}" class="error-message">
        <strong>Error:</strong> <span th:text="${error}"></span>
      </div>

      <!-- Warning Message -->
      <div th:if="${warning}" class="warning-message">
        <strong>Warning:</strong> <span th:text="${warning}"></span>
      </div>

      <!-- Filter Form -->
      <form method="get" action="/insights" id="filter-form">
        <div class="filter-section">
          <p class="filter-note">
            <strong>Note:</strong> Fields marked with
            <span class="required-indicator">*</span> are required.
          </p>
          <div class="filter-grid">
            <div class="combo-box-simple">
              <label for="start_year"
                >Start Year <span class="required-field">*</span></label
              >
              <input
                type="number"
                id="start_year"
                name="start_year"
                placeholder="2000"
                min="2000"
                max="2024"
                th:value="${selectedStartYear}"
                required
              />
            </div>

            <div class="combo-box-simple">
              <label for="end_year"
                >End Year <span class="required-field">*</span></label
              >
              <input
                type="number"
                id="end_year"
                name="end_year"
                placeholder="2024"
                min="2000"
                max="2024"
                th:value="${selectedEndYear}"
                required
              />
            </div>

            <div class="combo-box-simple">
              <label for="country">Country (Optional)</label>
              <input
                type="text"
                id="country"
                name="country"
                placeholder="All Countries"
                list="country-list"
                th:value="${selectedCountry}"
              />
              <datalist id="country-list">
                <option
                  th:each="country : ${countries}"
                  th:value="${country}"
                ></option>
              </datalist>
            </div>

            <div class="combo-box-simple">
              <label for="antigen">Vaccine Type (Optional)</label>
              <input
                type="text"
                id="antigen"
                name="antigen"
                placeholder="Type or select vaccine type"
                list="antigen-list"
                autocomplete="off"
                th:value="${selectedAntigen}"
              />
              <datalist id="antigen-list">
                <option
                  th:each="antigen : ${antigens}"
                  th:value="${antigen}"
                ></option>
              </datalist>
            </div>
          </div>

          <div class="filter-actions">
            <button type="submit" class="apply-btn">Apply Filters</button>
            <button
              type="button"
              class="reset-btn"
              onclick="window.location.href='/insights'"
            >
              Clear All
            </button>
          </div>
        </div>
      </form>

      <script>
        // Client-side year range validation
        document.getElementById('filter-form').addEventListener('submit', function(e) {
          const yearStart = document.getElementById('start_year');
          const yearEnd = document.getElementById('end_year');

          // Clear any previous custom validation messages
          yearStart.setCustomValidity('');
          yearEnd.setCustomValidity('');

          const startVal = parseInt(yearStart.value);
          const endVal = parseInt(yearEnd.value);

          if (yearStart.value && (startVal < 2000 || startVal > 2024)) {
            yearStart.setCustomValidity('Start year must be between 2000 and 2024');
            e.preventDefault();
            yearStart.reportValidity();
            return false;
          }

          if (yearEnd.value && (endVal < 2000 || endVal > 2024)) {
            yearEnd.setCustomValidity('End year must be between 2000 and 2024');
            e.preventDefault();
            yearEnd.reportValidity();
            return false;
          }

          if (yearStart.value && yearEnd.value && startVal > endVal) {
            yearStart.setCustomValidity('Start year cannot be greater than end year');
            e.preventDefault();
            yearStart.reportValidity();
            return false;
          }
        });

        // Clear validation messages on input
        document.getElementById('start_year').addEventListener('input', function() {
          this.setCustomValidity('');
        });
        document.getElementById('end_year').addEventListener('input', function() {
          this.setCustomValidity('');
        });
      </script>

      <!-- Initial State -->
      <div th:unless="${hasData}" class="initial-state-box">
        <p>
          Select a start year and end year to view vaccination rate
          improvements.
        </p>
      </div>
    </div>

    <!-- Results -->
    <div th:if="${hasData}" class="insights-results-card">
      <div class="insights-container">
        <div class="country-table">
          <h3>Country Improvement Data</h3>
          <table class="data-table">
            <thead>
              <tr>
                <th>Country</th>
                <th>Initial Coverage (%)</th>
                <th>Final Coverage (%)</th>
                <th>Improvement (% points)</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="item : ${geoData}">
                <td th:text="${item.country_name}">Country</td>
                <td
                  th:text="${item.initial_coverage != null ? item.initial_coverage + '%' : 'No Data'}"
                >
                  0%
                </td>
                <td
                  th:text="${item.final_coverage != null ? item.final_coverage + '%' : 'No Data'}"
                >
                  0%
                </td>
                <td
                  class="improvement-cell"
                  th:text="${item.improvement != null ? (item.improvement.startsWith('-') ? item.improvement : '+' + item.improvement) : 'No Data'}"
                >
                  0
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="insights-map-container">
          <div id="regions_div"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <p><strong>Global Health Dashboard</strong></p>
        <nav class="footer-links">
          <a href="/">Homepage</a> | <a href="/explore">Explore Data</a> |
          <a href="/trending">Trending</a> | <a href="/insights">Insights</a> |
          <a href="/mission">Mission Statement</a> |
          <a href="/feedback">Feedback</a> |
          <a href="/privacy">Privacy Policy</a>
        </nav>
        <p>
          <small>
            Â© 2025 RMIT University - Global Vaccination Initiatives | Empowering
            informed global health decisions
          </small>
        </p>
      </div>
    </footer>

    <!-- Chart Script -->
    <script th:inline="javascript">
      google.charts.load("current", {
        packages: ["geochart"],
      });

      google.charts.setOnLoadCallback(function () {
        drawChart();
      });

      function drawChart() {
        const chartDiv = document.getElementById("regions_div");
        if (!chartDiv) {
          return;
        }

        try {
          const geoChartData = /*[[${geoChartData}]]*/ "[]";

          // Parse the data
          const dataArray = JSON.parse(geoChartData);

          // Create data table
          const data = google.visualization.arrayToDataTable(dataArray);

          // Chart options
          const options = {
            title: "Vaccination Rate Improvement (Percentage Points)",
            colorAxis: {
              colors: [
                "#67001f", // Dark red - severe decline (-35)
                "#b2182b", // Red - major decline (-25)
                "#d6604d", // Light red - moderate decline (-15)
                "#f4a582", // Pale red - slight decline (-5)
                "#fddbc7", // Very pale red - minimal decline (-2)
                "#f7f7f7", // Neutral grey - no change (0)
                "#d1e5f0", // Very pale blue - minimal improvement (+5)
                "#92c5de", // Pale blue - slight improvement (+15)
                "#4393c3", // Light blue - moderate improvement (+30)
                "#2166ac", // Blue - good improvement (+50)
                "#08519c", // Dark blue - excellent improvement (+70)
                "#053061", // Very dark blue - outstanding improvement (+100)
              ],
              minValue: -35,
              maxValue: 100,
              legend: {
                position: "bottom",
                textStyle: {
                  color: "#333",
                  fontSize: 12,
                  bold: false,
                },
              },
            },
            backgroundColor: "#e8ecf0",
            datalessRegionColor: "#d0d5db",
            defaultColor: "#d0d5db",
            tooltip: {
              textStyle: {
                color: "#333",
                fontSize: 14,
              },
              showTitle: true,
            },
            region: "world",
          };

          // Draw chart
          const chart = new google.visualization.GeoChart(chartDiv);
          chart.draw(data, options);
        } catch (error) {
          chartDiv.innerHTML = `
                <div class="map-loading-error">
                    <h3>Map Loading Issue</h3>
                    <p>${error.message}</p>
                    <p>Please check the browser console for details.</p>
                </div>
            `;
        }
      }
    </script>
  </body>
</html>
